<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#000000">
  <title>–ê–Ω–∫–µ—Ç–∞ –Ω–∞ RealmSMP</title>
  <style>
    :root {
      --bg: #000;
      --text: #f5f5f7;
      --muted: #a0a4ad;
      --field: #151515;
      --stroke: #262626;
      --accent: #7dd0ff;
      --accent-dim: #0f2a36;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      padding: 0;
      opacity: 0;
      transform: translateY(8px);
      animation: pageIn .5s ease forwards .1s;
    }
    .sheet {
      position: relative;
      z-index: 2;
      width: min(430px, 100%);
      background: transparent;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      opacity: 0;
      transform: translateY(14px);
      animation: sheetIn .55s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
    }
    .content {
      margin-top: 28px;
      padding: 26px 22px 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      opacity: 0;
      transform: translateY(12px);
      animation: sheetIn .55s cubic-bezier(0.22, 0.61, 0.36, 1) .12s forwards;
    }
    .intro {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      text-align: center;
    }
    .intro-text { width: 100%; }
    .intro h1,
    .intro .hint {
      text-align: center;
    }
    .intro-image-wrap {
      width: 100%;
      display: flex;
      justify-content: center;
      opacity: 0;
      transform: translateY(8px);
      animation: itemIn .45s ease-out .08s forwards;
    }
    .attached-image {
      width: 120px;
      height: 120px;
      border-radius: 14px;
      object-fit: cover;
      display: block;
      flex-shrink: 0;
      transform-origin: 50% 100%;
      animation: sway 3.4s ease-in-out .4s infinite alternate;
      will-change: transform;
      transition: transform .2s ease, box-shadow .2s ease, filter .2s ease;
    }
    .attached-image:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 12px 28px rgba(0,0,0,0.32);
      filter: saturate(1.08);
    }
    h1 {
      margin: 0 0 2px;
      font-size: 26px;
      font-weight: 800;
      letter-spacing: -0.01em;
    }
    .hint {
      margin: 0;
      color: var(--muted);
      font-size: 15px;
      line-height: 1.6;
    }
    .group { display: flex; flex-direction: column; gap: 14px; }
    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
      opacity: 0;
      transform: translateY(8px);
      animation: itemIn .45s ease-out forwards;
      transition: transform .16s ease, background-color .16s ease;
    }
    .field:hover { transform: translateY(-1px); background-color: rgba(255,255,255,0.01); }
    .label { font-size: 14px; font-weight: 600; }
    .input,
    .textarea {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: var(--field);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition:
        border-color .14s ease,
        box-shadow .18s ease,
        background-color .2s ease,
        transform .18s ease,
        height .36s cubic-bezier(0.33, 0.12, 0.15, 1);
    }
    .input:focus,
    .textarea:focus {
      border-color: #b3b3b3;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.14);
    }
    .input:hover,
    .textarea:hover {
      border-color: #8b8b8b;
      background: #1a1a1a;
      box-shadow: 0 8px 20px rgba(0,0,0,0.32);
      transform: translateY(-1px);
    }
    .textarea {
      height: 44px;
      min-height: 44px;
      max-height: 260px;
      resize: none;
      overflow-y: auto;
      overflow-x: hidden;
      line-height: 1.5;
      will-change: height;
    }
    .textarea::-webkit-scrollbar { width: 0; height: 0; }
    .textarea { scrollbar-width: none; -ms-overflow-style: none; }
    .field.countered .textarea {
      padding-right: 88px;
      padding-bottom: 30px;
    }
    .counter {
      position: absolute;
      right: 12px;
      bottom: 10px;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      color: #c2c5cd;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.02em;
      pointer-events: none;
      line-height: 1;
      backdrop-filter: blur(6px);
    }
    .pills { display: flex; flex-direction: column; gap: 10px; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: var(--text);
      user-select: none;
      transition: transform .16s ease, color .18s ease;
    }
    .pill input {
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 8px;
      border: 1.5px solid #6f6f6f;
      background: #0f0f0f;
      position: relative;
      transition:
        transform .18s ease,
        box-shadow .2s ease,
        border-color .2s ease,
        background .2s ease;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
      cursor: pointer;
    }
    .pill input::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 7px;
      height: 12px;
      border: 2px solid transparent;
      border-top: 0;
      border-left: 0;
      transform: translate(-50%, -55%) rotate(42deg) scale(0.7);
      opacity: 0;
      transition: opacity .18s ease, transform .2s ease;
    }
    .pill input:hover {
      border-color: #c0c0c0;
      box-shadow: 0 0 0 6px rgba(255,255,255,0.08);
    }
    .pill input:active { transform: scale(0.94); }
    .pill input:focus-visible {
      outline: 2px solid #d9d9d9;
      outline-offset: 3px;
    }
    .pill input:checked {
      background: linear-gradient(135deg, #f6f6f6 0%, #dcdcdc 60%, #c7c7c7 100%);
      border-color: #e0e0e0;
      box-shadow: 0 8px 18px rgba(0,0,0,0.28), 0 0 0 2px rgba(255,255,255,0.08);
    }
    .pill input:checked::after {
      opacity: 1;
      border-bottom-color: #181818;
      border-right-color: #181818;
      transform: translate(-50%, -55%) rotate(42deg) scale(1);
    }
    .pill-text {
      transition: color .2s ease, transform .2s ease;
      display: inline-block;
    }
    .pill input:checked + .pill-text {
      color: #f2f2f2;
      transform: translateY(-1px);
    }
    .pill:hover .pill-text { color: #ffffff; transform: translateX(2px); }
    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
      position: relative;
      z-index: 2;
    }
    .submit-btn {
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: #f5f5f5;
      color: #0b0b0b;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition:
        transform .14s ease,
        box-shadow .18s ease,
        filter .16s ease,
        border-color .18s ease,
        background .18s ease;
    }
    .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
      filter: saturate(1.05);
      border-color: rgba(255,255,255,0.2);
    }
    .submit-btn:active {
      transform: translateY(0);
      box-shadow: 0 6px 16px rgba(0,0,0,0.28);
      background: #e8e8e8;
    }
    .submit-btn:focus-visible {
      outline: 2px solid #ffffff;
      outline-offset: 3px;
    }
    .submit-btn:disabled,
    .submit-btn[aria-disabled="true"] {
      background: #1e1e1e;
      color: #7a7a7a;
      border-color: #2c2c2c;
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
      filter: none;
    }
    @keyframes sheetIn {
      from { opacity: 0; transform: translateY(14px) scale(0.995); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    @keyframes itemIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes pageIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes sway {
      0%   { transform: rotate(1deg); }
      50%  { transform: rotate(-2deg); }
      100% { transform: rotate(1.5deg); }
    }
    .snow-canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100dvh;
      pointer-events: none;
      opacity: 0.88;
      filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.08));
    }
    .snow-canvas.back { z-index: 0; opacity: 0.32; }
    .snow-canvas.front { z-index: 1; opacity: 0.45; }
    .page-transition {
      position: fixed;
      inset: 0;
      background: #000;
      opacity: 0;
      pointer-events: none;
      transform: scale(1.01);
      z-index: 999;
    }
    .page-transition.active {
      animation: fadeOut .45s ease forwards;
    }
    @keyframes fadeOut {
      from { opacity: 0; transform: scale(1.01); }
      to   { opacity: 1; transform: scale(1.04); }
    }
    .screens {
      width: 100%;
      display: flex;
      justify-content: center;
    }
    .screen {
      display: none;
      width: 100%;
    }
    .screen.active {
      display: flex;
    }
    .form-screen {
      justify-content: center;
    }
    .pending-screen,
    .approved-screen {
      align-items: center;
      justify-content: center;
      padding: 32px 18px;
      min-height: 100vh;
    }
    .form-alert {
      margin: 4px 0 6px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: #f1f1f1;
      font-size: 13px;
      line-height: 1.5;
    }
    .form-alert.error {
      border-color: rgba(255, 120, 120, 0.35);
      background: rgba(255, 120, 120, 0.08);
      color: #ffd8d8;
    }
    .title-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 6px;
    }
    .title-row img {
      width: 150px;
      height: 150px;
      border-radius: 24px;
      object-fit: cover;
      border: none;
      box-shadow: none;
      animation: float 3.6s ease-in-out infinite;
      transform-origin: center;
    }
    .stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    .desc {
      display: flex;
      flex-direction: column;
      gap: 0;
      text-align: center;
    }
    .pending-card {
      width: min(440px, 100%);
      background: #0f0f0f;
      border: 1px solid var(--stroke);
      border-radius: 22px;
      padding: 18px 18px 20px;
      box-shadow: 0 18px 38px rgba(0,0,0,0.45);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .approved-card {
      width: min(440px, 100%);
      background: transparent;
      border-radius: 22px;
      padding: 10px 0 16px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .pending-card * ,
    .approved-card * { position: relative; z-index: 2; }
    .support-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #cfd3da;
      font-size: 13px;
      text-decoration: none;
      border-bottom: 1px solid rgba(255,255,255,0.3);
      padding-bottom: 2px;
      margin-top: 14px;
      transition: color .15s ease, border-color .15s ease, transform .15s ease;
    }
    .support-link:hover {
      color: #ffffff;
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-1px);
    }
    .support-link:active { transform: translateY(0); }
    .mini-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-weight: 700;
      font-size: 13px;
      text-decoration: none;
      transition: transform .12s ease, border-color .16s ease, background .16s ease, box-shadow .16s ease;
      margin-top: 6px;
    }
    .mini-btn:hover {
      transform: translateY(-1px);
      border-color: rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .mini-btn:active { transform: translateY(0); }
    .tip {
      margin-top: 12px;
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      text-align: center;
    }
    @keyframes float {
      0% { transform: translateY(0) rotate(0deg) scale(1); }
      50% { transform: translateY(-6px) rotate(-1deg) scale(1.01); }
      100% { transform: translateY(0) rotate(0.5deg) scale(1); }
    }
    @media (max-width: 520px) {
      .content { padding: 18px 16px 22px; gap: 16px; }
      .group { gap: 10px; }
      h1 { font-size: 20px; }
      .hint { font-size: 13.5px; line-height: 1.45; }
    }
    @media (max-width: 400px) {
      .content { padding: 16px 14px 20px; gap: 14px; }
      h1 { font-size: 19px; }
    }
  </style>
</head>
<body>
  <canvas id="snowCanvasBack" class="snow-canvas back" aria-hidden="true"></canvas>
  <canvas id="snowCanvasFront" class="snow-canvas front" aria-hidden="true"></canvas>
  <div class="page-transition" id="pageTransition" aria-hidden="true"></div>
  <main class="screens">
    <section id="formScreen" class="screen form-screen" hidden>
      <div class="sheet">
        <div class="content">
          <div class="intro">
            <div class="intro-image-wrap">
              <img class="attached-image" src="IMG_2661.PNG" alt="–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è RealmSMP" loading="lazy" decoding="async">
            </div>
            <div class="intro-text">
              <h1>–ê–Ω–∫–µ—Ç–∞ –Ω–∞ RealmSMP</h1>
              <p class="hint">–∞–Ω–∫–µ—Ç—É –≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑</p>
            </div>
          </div>

          <div class="group">
            <label class="field">
              <span class="label">–¢–≤–æ—ë –∏–º—è –∏–ª–∏ –Ω–∏–∫</span>
              <input class="input" type="text" name="name" placeholder="Frost / –í–æ–≤–∞" autocomplete="name" maxlength="30" required>
            </label>

            <label class="field">
              <span class="label">–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç?</span>
              <input class="input" type="text" name="age" inputmode="numeric" pattern="[0-9]{1,2}" maxlength="2" placeholder="18" aria-label="–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç" required>
            </label>

            <label class="field countered">
              <span class="label">–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ</span>
              <textarea class="textarea" rows="1" name="about" placeholder="–∫—Ç–æ —Ç—ã, —á—Ç–æ –∏–∑ —Å–µ–±—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å, —Å—Ç–∞–∂ –∏–≥—Ä—ã, —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–æ–µ–∫—Ç—ã/–∫–∞–Ω–∞–ª—ã" maxlength="250" required></textarea>
              <span class="counter" data-counter="about">0/250</span>
            </label>

            <div class="field">
              <span class="label">–° —á–µ–º –±—É–¥–µ—à—å –∏–≥—Ä–∞—Ç—å?</span>
              <div class="pills">
                <label class="pill"><input type="checkbox" name="with_cam" value="cam"><span class="pill-text">–≤–µ–±–∫–∞</span></label>
                <label class="pill"><input type="checkbox" name="with_voice" value="voice"><span class="pill-text">–≤–æ–π—Å</span></label>
              </div>
            </div>

            <label class="field">
              <span class="label">–ù–∏–∫ –≤ Minecraft (–≤–∞–π—Ç-–ª–∏—Å—Ç)</span>
              <input class="input" type="text" name="mc_nick" placeholder="RealmPlayer" maxlength="32" required>
            </label>

          </div>

          <div class="field countered" style="margin-top: 6px;">
            <span class="label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –±–æ—Ç–∞</span>
            <textarea class="textarea" rows="1" name="comment" placeholder="–Ω–µ–æ–±–µ–∑–∞—Ç–µ–ª—å–Ω–æ" aria-label="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –±–æ—Ç–∞" maxlength="66"></textarea>
            <span class="counter" data-counter="comment">0/66</span>
          </div>

          <div class="actions">
            <div class="form-alert error" id="formMessage" hidden role="alert"></div>
            <button type="button" class="submit-btn" id="submitBtn" disabled aria-disabled="true">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
          </div>

        </div>
      </div>
    </section>

    <section id="pendingScreen" class="screen pending-screen" hidden>
      <div class="pending-card">
        <div class="title-row">
          <img src="–∑–∞–≥—Ä—É–∑–∫–∞.gif" alt="–ö–æ—Ç–∏–∫ –∂–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞" loading="lazy" decoding="async">
        </div>
        <div class="stack">
          <h1>–ó–∞—è–≤–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ</h1>
          <div class="desc">
            <p>–ú—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ —Ç–≤–æ—é –∞–Ω–∫–µ—Ç—É –∏ —Å–∫–æ—Ä–æ –ø–æ—Å–º–æ—Ç—Ä–∏–º.</p>
            <p>–û–±—ã—á–Ω–æ —ç—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–µ –±–æ–ª–µ–µ 24 —á–∞—Å–æ–≤.</p>
          </div>
          <a class="support-link" href="https://t.me/RealmSMPSupport_bot" target="_blank" rel="noopener noreferrer">
            <span>–Ω–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</span>
          </a>
        </div>
        <div class="tip">–º—ã —É–≤–µ–¥–æ–º–∏–º –≤ –±–æ—Ç–µ, –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è —Ä–µ—à–µ–Ω–∏–µ</div>
      </div>
    </section>

    <section id="approvedScreen" class="screen approved-screen" hidden>
      <div class="approved-card">
        <div class="title-row">
          <img src="1234.gif" alt="–û–¥–æ–±—Ä–µ–Ω–æ" loading="lazy" decoding="async">
        </div>
        <div class="stack">
          <h1>–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞ üéâüéâüéâ</h1>
          <div class="desc">
            <p>–¢–≤–æ—è –∞–Ω–∫–µ—Ç–∞ –ø—Ä–æ—à–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫—É ‚Äî –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</p>
          </div>
          <a class="mini-btn" href="http://t.me/realmSMP_bot/inf" target="_blank" rel="noopener noreferrer">—á—Ç–æ –¥–∞–ª—å—à–µ</a>
        </div>
      </div>
    </section>
  </main>
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbycIzLeRQSG8zmZHtQ0NSbtlr-eZVw77dAIKE6rHKrN21Vf-ikx5wqfb1dXKWySMsEH2w/exec';
    const screens = {
      form: document.getElementById('formScreen'),
      pending: document.getElementById('pendingScreen'),
      approved: document.getElementById('approvedScreen'),
    };
    const formMessageEl = document.getElementById('formMessage');
    const tg = window.Telegram?.WebApp;
    const user = tg?.initDataUnsafe?.user;
    const userId = user?.id;
    tg?.ready?.();

    function hideAllScreens() {
      Object.values(screens).forEach((screen) => {
        if (!screen) return;
        screen.classList.remove('active');
        screen.setAttribute('hidden', 'true');
      });
    }

    function showForm() {
      hideAllScreens();
      if (screens.form) {
        screens.form.classList.add('active');
        screens.form.removeAttribute('hidden');
      }
    }

    function showPending() {
      hideAllScreens();
      if (screens.pending) {
        screens.pending.classList.add('active');
        screens.pending.removeAttribute('hidden');
      }
    }

    function showApproved() {
      hideAllScreens();
      if (screens.approved) {
        screens.approved.classList.add('active');
        screens.approved.removeAttribute('hidden');
      }
    }

    const setFormMessage = (text, isError = true) => {
      if (!formMessageEl) return;
      if (!text) {
        formMessageEl.hidden = true;
        formMessageEl.textContent = '';
        formMessageEl.classList.remove('error');
        return;
      }
      formMessageEl.hidden = false;
      formMessageEl.textContent = text;
      formMessageEl.classList.toggle('error', isError);
    };

    const autoGrow = (el) => {
      const minH = 44;
      const maxH = parseFloat(getComputedStyle(el).maxHeight) || 260;
      const setHeight = () => {
        const current = el.offsetHeight;
        el.style.height = 'auto';
        const target = Math.min(Math.max(el.scrollHeight, minH), maxH);
        if (current === target) {
          el.style.height = `${target}px`;
          return;
        }
        el.style.height = `${current}px`;
        requestAnimationFrame(() => { el.style.height = `${target}px`; });
      };

      const init = () => {
        const saved = el.style.transition;
        el.style.transition = 'none';
        setHeight();
        requestAnimationFrame(() => { el.style.transition = saved || ''; });
      };

      el.addEventListener('input', () => {
        setHeight();
      });

      init();
    };

    const updateCounter = (el) => {
      if (!el.name || el.maxLength <= 0) return;
      const counter = document.querySelector(`[data-counter="${el.name}"]`);
      if (!counter) return;
      counter.textContent = `${el.value.length}/${el.maxLength}`;
    };

    const attachCounters = (nodeList) => {
      nodeList.forEach((el) => {
        updateCounter(el);
        el.addEventListener('input', () => updateCounter(el));
      });
    };

    document.querySelectorAll('.textarea').forEach(autoGrow);
    attachCounters(document.querySelectorAll('.textarea, .input'));

    // Simple audio cues. Quiet and pooled so every keypress sounds.
    const audioManager = (() => {
      const makePool = (src, size = 4, baseVolume = 0.16) => {
        const pool = Array.from({ length: size }, () => {
          const a = new Audio(src);
          a.preload = 'auto';
          a.volume = baseVolume;
          return a;
        });
        let idx = 0;
        const prime = () => {
          pool.forEach((a) => {
            const restore = () => { a.pause(); a.currentTime = 0; a.muted = false; };
            a.muted = true;
            const p = a.play();
            if (p && typeof p.then === 'function') p.then(restore).catch(restore);
            else restore();
          });
        };
        const play = (volume = baseVolume) => {
          const a = pool[idx];
          idx = (idx + 1) % pool.length;
          try {
            a.currentTime = 0;
            a.volume = volume;
            const p = a.play();
            if (p && typeof p.catch === 'function') p.catch(() => {});
          } catch (_) {
            /* ignore */
          }
        };
        return { play, prime };
      };

      const pools = {
        click: makePool('click.mp3', 5, 0.14),
        deny: makePool('deny.mp3', 3, 0.16),
      };

      let unlocked = false;
      const unlock = () => {
        if (unlocked) return;
        unlocked = true;
        Object.values(pools).forEach((p) => p.prime());
      };

      window.addEventListener('pointerdown', unlock, { passive: true, once: true });
      window.addEventListener('keydown', unlock, { passive: true, once: true });

      return {
        play(name, volume) {
          const pool = pools[name];
          if (!pool) return;
          pool.play(volume);
        },
      };
    })();

    const submitBtn = document.getElementById('submitBtn');
    const requiredNames = ['name', 'age', 'about', 'mc_nick'];
    const checkboxNames = ['with_cam', 'with_voice'];
    let isSubmitting = false;

    const allRequiredFilled = () => {
      const fieldsOk = requiredNames.every((name) => {
        const el = document.querySelector(`[name="${name}"]`);
        return el && el.value.trim().length > 0;
      });
      const anyChecked = checkboxNames.some((name) => {
        const el = document.querySelector(`[name="${name}"]`);
        return el && el.checked;
      });
      return fieldsOk && anyChecked;
    };

    const canSubmit = () => allRequiredFilled() && !!userId && !isSubmitting;

    const syncSubmitState = () => {
      if (!submitBtn) return;
      const filled = canSubmit();
      submitBtn.disabled = !filled;
      submitBtn.setAttribute('aria-disabled', filled ? 'false' : 'true');
    };

    const bindAudio = () => {
      document.querySelectorAll('.input, .textarea').forEach((el) => {
        el.addEventListener('focus', () => audioManager.play('click', 0.14));
        el.addEventListener('input', () => {
          audioManager.play('click', 0.12);
          syncSubmitState();
        });
      });
      document.querySelectorAll('.pill input').forEach((el) => {
        el.addEventListener('change', () => {
          audioManager.play('click', 0.16);
          syncSubmitState();
        });
      });
    };

    // Allow only numbers in age field
    const ageInput = document.querySelector('input[name="age"]');
    if (ageInput) {
      ageInput.addEventListener('input', () => {
        const digits = ageInput.value.replace(/\D/g, '').slice(0, 2);
        if (digits !== ageInput.value) ageInput.value = digits;
        syncSubmitState();
      });
    }

    const collectAnswers = () => {
      const answers = {};
      document.querySelectorAll('input[name], textarea[name]').forEach((el) => {
        if (el.type === 'checkbox') {
          answers[el.name] = el.checked;
        } else {
          answers[el.name] = el.value.trim();
        }
      });
      return answers;
    };

    const callApi = async (payload) => {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 12000);
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal,
        });

        const raw = await response.text();
        let data = null;
        try {
          data = raw ? JSON.parse(raw) : null;
        } catch (_) {
          throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç');
        }

        if (!response.ok) {
          throw new Error(data?.error || `–û—à–∏–±–∫–∞ ${response.status}`);
        }
        if (!data) throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
        return data;
      } catch (err) {
        if (err?.name === 'AbortError') {
          throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (12—Å)');
        }
        throw err instanceof Error ? err : new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      } finally {
        clearTimeout(timer);
      }
    };

    const checkStatus = async () => {
      if (!userId) {
        setFormMessage('–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram');
        showForm();
        syncSubmitState();
        return;
      }
      try {
        setFormMessage('');
        const data = await callApi({ action: 'status', telegram_id: userId });
        if (data?.status === 'APPROVED') {
          showApproved();
        } else if (data?.status === 'PENDING') {
          showPending();
        } else {
          showForm();
        }
      } catch (err) {
        setFormMessage(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
        showForm();
      } finally {
        syncSubmitState();
      }
    };

    const submitApplication = async () => {
      if (!submitBtn || submitBtn.disabled || isSubmitting) return;
      if (!userId) {
        setFormMessage('–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram');
        return;
      }
      isSubmitting = true;
      syncSubmitState();
      submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
      setFormMessage('');
      try {
        const answers = collectAnswers();
        const res = await callApi({ action: 'submit', telegram: user, answers });
        if (res?.ok) {
          showPending();
        } else if (res?.error === 'ALREADY_SUBMITTED') {
          await checkStatus();
        } else if (res?.error) {
          setFormMessage(res.error);
          showForm();
        } else {
          showPending();
        }
      } catch (err) {
        setFormMessage(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É');
        showForm();
      } finally {
        isSubmitting = false;
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
        syncSubmitState();
      }
    };

    submitBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      audioManager.play('click', 0.18);
      submitApplication();
    });

    // Init state
    hideAllScreens();
    syncSubmitState();
    bindAudio();
    checkStatus();

    // Snow effect (front + back layers)
    const startSnow = (id, density = 1) => {
      const canvas = document.getElementById(id);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;

      const flakes = [];
      const dpr = Math.min(window.devicePixelRatio || 1, 2.5);
      let width = window.innerWidth;
      let height = window.innerHeight;
      let maxFlakes = 0;
      const wind = { value: 0, target: 0, lastShift: performance.now(), cadence: 2200 + Math.random() * 900 };

      const createFlake = (startY) => {
        const layerChance = Math.random();
        const layer = layerChance > 0.65 ? 'near' : layerChance > 0.3 ? 'mid' : 'far';
        const depth = layer === 'near' ? 1 : layer === 'mid' ? 0.72 : 0.52;
        return {
          x: Math.random() * width,
          y: typeof startY === 'number' ? startY : Math.random() * height,
          r: (0.9 + Math.random() * 2.2) * depth,
          speed: (0.08 + Math.random() * 0.55) * depth,
          drift: (Math.random() - 0.5) * 0.22 * depth,
          sway: Math.random() * Math.PI * 2,
          swaySpeed: (0.0006 + Math.random() * 0.0015) * depth,
          twinklePhase: Math.random() * Math.PI * 2,
          twinkleSpeed: 0.0007 + Math.random() * 0.0013,
          opacity: 0.35 + Math.random() * 0.5,
          depth,
        };
      };

      const resizeSnow = () => {
        width = window.innerWidth;
        height = window.innerHeight;
        maxFlakes = Math.min(150 * density, Math.floor((width / 4.4) * density));
        canvas.width = Math.floor(width * dpr);
        canvas.height = Math.floor(height * dpr);
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        while (flakes.length < maxFlakes) flakes.push(createFlake(Math.random() * height));
        flakes.length = Math.floor(maxFlakes);
      };

      let lastFrame = performance.now();
      const renderSnow = (now) => {
        const delta = Math.min(32, now - lastFrame);
        lastFrame = now;
        const driftScale = delta / 16;

        if (now - wind.lastShift > wind.cadence) {
          wind.target = (Math.random() - 0.5) * 0.22;
          wind.lastShift = now;
          wind.cadence = 2200 + Math.random() * 1200;
        }
        wind.value += (wind.target - wind.value) * 0.0016 * delta;

        ctx.clearRect(0, 0, width, height);

        flakes.sort((a, b) => a.depth - b.depth);
        for (let i = 0; i < flakes.length; i++) {
          const flake = flakes[i];
          flake.sway += flake.swaySpeed * delta;
          flake.twinklePhase += flake.twinkleSpeed * delta;
          const swayOffset = Math.sin(flake.sway) * (0.5 + flake.r * 0.035);
          flake.x += swayOffset + (flake.drift + wind.value) * driftScale;
          flake.y += (flake.speed + flake.r * 0.025) * driftScale;

          if (flake.y > height + 10 || flake.x < -12 || flake.x > width + 12) {
            flakes[i] = createFlake(-16);
            continue;
          }

          const flicker = 0.82 + Math.sin(flake.twinklePhase) * 0.18;
          ctx.globalAlpha = Math.min(1, Math.max(0.1, flake.opacity * flicker));
          ctx.beginPath();
          ctx.fillStyle = 'rgba(255, 255, 255, 1)';
          ctx.shadowColor = 'rgba(255, 255, 255, 0.2)';
          ctx.shadowBlur = 3 + flake.r * 2;
          ctx.arc(flake.x, flake.y, flake.r, 0, Math.PI * 2);
          ctx.fill();
          ctx.globalAlpha = 1;
        }

        requestAnimationFrame(renderSnow);
      };

      resizeSnow();
      requestAnimationFrame(renderSnow);
      window.addEventListener('resize', resizeSnow);
    };

    startSnow('snowCanvasBack', 0.6);
    startSnow('snowCanvasFront', 1);
  </script>
</body>
</html>
